<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="party">
	
	<!-- //sido로 카페No, 카페이름가져오기 -->
	<select id="cafeListSelect" parameterType="String" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select cafeNo,
				   cafeName
			from cafe
		]]>
			<choose>
				<when test="_parameter == '전국'">
				</when>
				<otherwise>
					<choose>
						<when test="_parameter == '서울'">
							where sido = #{sido}
						</when>
						<otherwise>
							<choose>
								<when test="_parameter != '' and _parameter != null">
									where sidoDetail = #{sido}
								</when>
							</choose>
						</otherwise>
					</choose>
				</otherwise>
			</choose>
		
		<![CDATA[
		]]>
	</select>
	
	
	<!-- cafeNo로 테마NO, 테마이름가져오기 -->
	<select id="themeListSelect" parameterType="int" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select themeNo,
       			   themename
			from cafe c,
     			 theme t
			where c.cafeno = t.cafeno
			and c.cafeno = #{cafeNo}
		]]>
	</select>
	
	
	<!-- themeNo로 시간표 가져오기 -->
	<select id="themeTimeListSelect" parameterType="int" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select themeTime
			from themeTime
			where themeNo = #{themeNo}
		]]>
	</select>
	
	
	<!-- 파티등록폼에서 넘어온 정보로 파티리스트 인서트! -->
	<insert id="addPartyList" parameterType="com.nextroom.vo.PartyVo">
		<selectKey keyProperty="partyNo" resultType="int" order="BEFORE">
			<![CDATA[
				select partyNo.nextval from dual
			]]>
		</selectKey>
		
		<![CDATA[
			INSERT INTO party
			VALUES (#{partyNo},
					#{userNo},
	       			'',
	       			#{reserveDate},
	       			#{cafeNo},
	       			#{themeNo},
	       			'',
	       			#{themeTime},
	       			#{reservePerson},
	       			#{content},
	       			'모집중')	
		]]>
	</insert>
	
	
	<!-- 셀렉트키로 가져온 PARTYNO와 USERNO로 파티참여리스트 INSERT -->
	<insert id="addPartyDetail" parameterType="com.nextroom.vo.PartyVo">
		<![CDATA[
			INSERT INTO PARTYDETAIL
			VALUES(#{partyNo},
				   #{userNo},
				   '1')
		]]>
	</insert>
	
	
	<!-- 파티등록 리스트 목록 출력하기 -->
	<select id="partyListSelect" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select partyNo,
				   userNo,
       			   reservedateno,
       			   to_char(reserveDate, 'YY-MM-DD') reserveDate,
       			   cafeNo,
       			   themeno,
       			   reservedateno,
       			   themeTime,
       			   reserveperson,
       			   content,
       		   	   partystate
			from party
			order by partyNo desc
		]]>
	</select>
	
	<!-- 파티리스트에서 뽑아낸 cafeNo로 가져오는 정보리스트 -->
	<select id="getCafeNoList" parameterType="int" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select sidodetail,
       			   cafename
			from cafe
			where cafeno = #{cafeNo}
		]]>
	</select>
	
	<!-- cafeNo와 themeNo 뽑아서 필요한 정보가져오기 -->
	<select id="getCafeThemeNoList" parameterType="com.nextroom.vo.PartyVo" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select t.themename,
       			   t.themeimg,
     			   t.jenre,
       			   t.levels,
       			   t.playtime,
       			   t.themetype
			from cafe c,
     			 theme t
			where c.cafeno = t.cafeno
			and c.cafeno = #{cafeNo}
			and t.themeno = #{themeNo}
		]]>
	</select>
	
	<!-- partyNo로 유저카운트 가져오기 -->
	<select id="getPartyNoList" parameterType="int" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select count(userNo) userCount
			from partydetail
			where partyNo = #{partyNo}
		]]>
	</select>
	
	
	<!-- 리스트에서 넘어온 파티No로 partyRead에 정보 뿌려주기 -->
	<select id="getPartyReadList" parameterType="int" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select partyNo,
       			   userno,
		       	   reservedateno,
		       	   to_char(reservedate, 'YY-MM-DD') reserveDate,
		       	   cafeNo,
		       	   themeno,
		       	   reservedateno,
		      	   themetime,
		       	   reserveperson,
		       	   content,
		       	   partystate
			from party
			where partyNo = #{partyNo}
		]]>
	</select>
	
	<!-- partyNo로 파티승인멤버 리스트 가져오기 -->
	<select id="partyDetailList" parameterType="int" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select partyNo,
       			   userNo,
       			   userState
			from partydetail
			where partyNo = #{partyNo}
		]]>
	</select>
	
	<!-- partyNo로 파티대기멤버 리스트 가져오기 -->
	<select id="partyApplicantList" parameterType="int" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select partyNo,
       			   userNo
			from partyapplicant
			where partyNo = #{partyNo}
		]]>
	</select>
	
	
	<!-- partyRead에서 파티삭제를 위한 partyNo 받기 -->
	<delete id="partyDelete" parameterType="int">
		<![CDATA[
			delete from party
			where partyNo = #{partyNo} 
		]]>
	</delete>
	
	
	<!-- partyRead에서 참여자가 참여신청을 눌렀을 경우 -->
	<select id="selectPartyApplicant" parameterType="com.nextroom.vo.PartyVo" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select userNo
			from partyapplicant
			where partyNo = #{partyNo}
			and userNo = #{userNo}
		]]>
	</select>
	
	<!-- partyRead에서 참여자가 참여신청을 눌렀을 경우 partyDetail에 있는지 확인 -->
	<select id="partyDetailCheckSelect" parameterType="com.nextroom.vo.PartyVo" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select userNo
			from partydetail
			where partyNo = #{partyNo}
			and userNo = #{userNo}
		]]>
	</select>
	
	<!-- partyRead에서 참여자가 참여신청을 눌렀을때 성공했을경우 INSERT -->
	<insert id="insertApplicant" parameterType="com.nextroom.vo.PartyVo">
		<![CDATA[
			INSERT into partyapplicant
			VALUES (#{partyNo} ,
        			#{userNo}
        			)
		]]>
	</insert>
	
	
	<!-- partyRead에서 참여자가 참가취소를 눌렀을 경우 -->
	<delete id="deleteApplicant" parameterType="com.nextroom.vo.PartyVo">
		<![CDATA[
			delete from partyapplicant
			where partyNo = #{partyNo}
			and userNo = #{userNo}
		]]>
	</delete>
	
	
	<!-- partyNo로 party reservePerson 가져오기 -->
	<select id="getReservePerson" parameterType="int" resultType="com.nextroom.vo.PartyVo">
		<![CDATA[
			select reserveperson
			from party
			where partyNo = #{partyNo}
		]]>
	</select>
	
	
	<!-- 파티대기멤버 파티승인멤버로 인서트 -->
	<insert id="pDetailEntryMember" parameterType="com.nextroom.vo.PartyVo">
		<![CDATA[
			INSERT into partydetail
			VALUES (#{partyNo},
        			#{userNo},
        			'2')
		]]>		
	</insert>
	
	
	<!-- 방장이 partyDetail에서 멤버취소를 눌렀을 경우 -> partyDetail에서 멤버삭제 -->
	<delete id="exceptDetailMember" parameterType="com.nextroom.vo.PartyVo">
		<![CDATA[
			delete from partydetail
			where partyNo = #{partyNo}
			and userNo = #{userNo}
		]]>
	</delete>
	
	
	
	
</mapper>